<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <title>Flow Rate Monitoring App</title>
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --bg: #f6f8fb;
            --card: #fff;
            --accent: #1565c0;
            --ok: #2e7d32;
            --warn: #fbc02d;
            --danger: #c62828;
            --muted: #6b7280;
            font-family: Inter, system-ui, Segoe UI, Roboto, Arial;
        }

        body {
            background: var(--bg);
            margin: 0;
            padding: 18px;
            color: #111;
        }

        .container {
            max-width: 1250px;
            margin: 0 auto;
        }

        h1 {
            margin: 0 0 12px;
            font-size: 20px;
        }

        .grid {
            display: grid;
            grid-template-columns: 1fr 420px;
            gap: 16px;
        }

        .card {
            background: var(--card);
            padding: 14px;
            border-radius: 10px;
            box-shadow: 0 6px 18px rgba(16, 24, 40, 0.06);
        }

        label {
            display: block;
            font-size: 13px;
            color: var(--muted);
            margin-top: 8px;
        }

        input {
            width: 100%;
            padding: 8px;
            border-radius: 6px;
            border: 1px solid #e6e9ef;
            margin-top: 6px;
            box-sizing: border-box;
        }

        .row {
            display: flex;
            gap: 8px;
        }

        .row>* {
            flex: 1;
        }

        button {
            border: 0;
            padding: 10px 12px;
            border-radius: 8px;
            cursor: pointer;
            color: white;
            font-weight: 600;
            margin-top: 10px;
            width: 100%;
            font-size: 14px;
        }

        .openBtn {
            background: var(--ok);
        }

        .closeBtn {
            background: var(--danger);
        }

        .nextplate {
            background: #9e9e9e;
        }

        .reset {
            background: var(--warn);
            color: #000;
        }

        .complete {
            background: var(--ok);
        }

        .logoutBtn {
            background: #616161;
            margin-top: 10px;
        }

        .themeToggleBtn {
            background: #424242;
            margin-top: 0;
            width: 120px;
        }

        .metrics {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            margin-top: 10px;
        }

        .metric {
            flex: 1 1 140px;
            background: #f8fbff;
            padding: 10px;
            border-radius: 8px;
            font-weight: 600;
        }

        .progress-wrap {
            background: #eee;
            border-radius: 12px;
            padding: 6px;
            margin-top: 8px;
        }

        .progress {
            height: 18px;
            background: linear-gradient(90deg, var(--accent), #64b5f6);
            width: 0%;
            border-radius: 10px;
        }

        .small {
            font-size: 12px;
            color: var(--muted);
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 8px;
            font-size: 13px;
        }

        th,
        td {
            padding: 8px 6px;
            border-bottom: 1px solid #f0f2f7;
            text-align: left;
        }

        canvas {
            background: #fff;
            border-radius: 8px;
            padding: 8px;
            margin-top: 12px;
        }

        @media(max-width:980px) {
            .grid {
                grid-template-columns: 1fr;
            }
        }

        .historyBox {
            margin-top: 10px;
            border-top: 1px solid #ddd;
            padding-top: 8px;
        }

        select {
            padding: 5px;
            border-radius: 6px;
            border: 1px solid #ccc;
        }

        #app-content {
            display: none;
        }

        .login-box {
            background: var(--card);
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 6px 18px rgba(16, 24, 40, 0.06);
            max-width: 400px;
            margin: 100px auto;
            text-align: center;
        }

        .login-box h2 {
            margin-top: 0;
            text-align: center;
            color: var(--accent);
        }

        #loginMessage {
            color: var(--danger);
            text-align: center;
            margin-top: 10px;
        }

        .loginBtn {
            background: var(--accent);
        }

        .login-image {
            margin-bottom: 20px;
        }

        .login-image img {
            max-width: 150px;
            height: auto;
            border-radius: 8px;
            border: 1px solid #ddd;
        }

        #employeeId::-webkit-outer-spin-button,
        #employeeId::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

        #employeeId[type=number] {
            -moz-appearance: textfield;
        }

        body.dark-mode {
            --bg: #121212;
            --card: #1e1e1e;
            --accent: #64b5f6;
            --ok: #4caf50;
            --warn: #ffb74d;
            --danger: #ef5350;
            --muted: #b0b0b0;
            color: #ffffff;
        }

        body.dark-mode .card {
            background: var(--card);
            box-shadow: 0 6px 18px rgba(0, 0, 0, 0.3);
        }

        body.dark-mode input {
            background: #2d2d2d;
            color: #ffffff;
            border: 1px solid #444;
        }

        body.dark-mode select {
            background: #2d2d2d;
            color: #ffffff;
            border: 1px solid #444;
        }

        body.dark-mode .metric {
            background: #2d2d2d;
        }

        body.dark-mode .progress-wrap {
            background: #2d2d2d;
        }

        body.dark-mode table {
            color: #ffffff;
        }

        body.dark-mode th,
        body.dark-mode td {
            border-bottom: 1px solid #444;
        }

        body.dark-mode canvas {
            background: #2d2d2d;
        }

        body.dark-mode .historyBox {
            border-top: 1px solid #444;
        }

        body.dark-mode .login-box {
            background: #1e1e1e;
            color: #ffffff;
        }

        body.dark-mode .login-box input {
            background: #2d2d2d;
            color: #ffffff;
            border: 1px solid #444;
        }

    </style>
</head>

<body>
    <div class="container">

        <div id="login-screen">
            <div class="login-box">
                <div class="login-image">
                    <img src="./saarloha_logo.jpeg" alt="SAARLOHA Logo">
                </div>
                <h2>System Login</h2>
                <label for="employeeId">Employee ID</label>
                <input id="employeeId" type="number" placeholder="Enter Employee ID">

                <label for="password">Password</label>
                <input id="password" type="password" placeholder="Enter Password">

                <button id="loginBtn" class="loginBtn">LOG IN</button>
                <div id="loginMessage"></div>
            </div>
        </div>

        <div id="app-content">

            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                <h1>Flow Rate Monitoring App</h1>
                <div class="header-buttons">
                    <button id="themeToggleBtn" class="themeToggleBtn">ðŸŒ™ DARK MODE</button>
                    <button id="logoutBtn" class="logoutBtn" style="width: 120px; margin-top: 0;">LOG OUT</button>
                </div>
            </div>

            <div class="grid">
                <div class="card">
                    <!-- Pre-casting & Pouring control content here -->
                    <!-- same as your original code -->
                </div>

                <div class="card">
                    <h3>Plate Completion Log</h3>
                    <table id="logTable">
                        <thead>
                            <tr>
                                <th>Plate</th>
                                <th>Target (t)</th>
                                <th>Actual (t)</th>
                                <th>Time (min)</th>
                                <th>Remarks</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                    <h3 style="margin-top:12px">End of Heat Summary</h3>
                    <div style="display:flex;gap:8px;margin-top:8px;">
                        <div style="flex:1;background:#f8fbff;padding:10px;border-radius:8px;">
                            <div class="small">Total Poured (tons)</div>
                            <div id="totalPoured" style="font-weight:600;color:#111;">0.00</div>
                        </div>
                        <div style="flex:1;background:#fff8f0;padding:10px;border-radius:8px;">
                            <div class="small">Ladle Remaining (tons)</div>
                            <div id="ladleRem" style="font-weight:600;color:#111;">0.00</div>
                        </div>
                    </div>
                    <div style="margin-top:12px;display:flex;flex-direction:column;gap:8px;">
                        <button id="exportCSV" style="background:#1976d2;">Export</button>
                        <button id="resetBtn" class="reset">RESET</button>
                        <button id="completeBtn" class="complete">COMPLETE</button>
                    </div>
                    <div class="historyBox">
                        <h4>Heat History</h4>
                        <select id="filterSelect">
                            <option value="all">All Heats</option>
                            <option value="week">This Week</option>
                            <option value="month">This Month</option>
                        </select>
                        <div id="historyList" class="small" style="margin-top:6px;"></div>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <script>
        // ===============================
        // All your existing JS code here
        // ===============================

        // --- CSV Export Fix ---
        document.getElementById("exportCSV").addEventListener("click", function () {

            let table = document.getElementById("logTable").getElementsByTagName("tbody")[0];
            let rows = table.querySelectorAll("tr");

            if (rows.length === 0) {
                alert("No data to export!");
                return;
            }

            let csv = "Plate,Target (t),Actual (t),Time (min),Remarks\n";

            rows.forEach(row => {
                let cols = row.querySelectorAll("td");
                let line = [];
                cols.forEach(col => {
                    line.push(col.innerText);
                });
                csv += line.join(",") + "\n";
            });

            let blob = new Blob([csv], { type: "text/csv" });
            let url = URL.createObjectURL(blob);

            let a = document.createElement("a");
            a.href = url;
            a.download = "flowrate_log.csv";
            document.body.appendChild(a);
            a.click();
            a.remove();

            // Android WebView fix
            window.location.href = url;
        });

        // ===============================
        // All other JS (flow chart, login, pouring, dark mode) stays untouched
        // ===============================
    </script>
</body>

</html>
